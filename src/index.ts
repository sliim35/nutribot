/**
 * Learn more at https://developers.cloudflare.com/workers/
 */
import { Router } from 'itty-router';
import { Markup, Telegraf } from 'telegraf';
import OpenAI from 'openai';
import { message } from 'telegraf/filters';
import { Update } from 'telegraf/types';

const router = Router();

const model = 'gpt-4o-mini';
const escapeSymbols = '_ * [ ] ( ) ~ ` > # + - = | { } . !';

const getRecommendationMessage = (message = '') => `
        –ù–∞–ø–∏—à–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: ${message} –∫–ª–∏–µ–Ω—Ç–∞ (—É—á—Ç–∏, —á—Ç–æ –≤ –∑–∞–ø—Ä–æ—Å–µ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –∏ –∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç),  –∫—Ä–∞—Ç–∫–æ–µ, –Ω–æ –µ–º–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ –µ–≥–æ –ø—Ä–æ–±–ª–µ–º—ã. 
        –¢–∞–∫–∂–µ —É—á—Ç–∏, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç —É–ª—É—á—à–∏—Ç—å —Å–≤–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∂–∏–∑–Ω–∏ —á–µ—Ä–µ–∑ –ø–∏—Ç–∞–Ω–∏–µ –∏ –ø—Ä–∏–µ–º –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∏ –º–∏–Ω–µ—Ä–∞–ª–æ–≤, –∞ —Ç–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∑–¥–æ—Ä–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏.

        –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
        - –û—Ç–≤–µ—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ —á–µ–º —Ç—Ä–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. 
        - –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ª–µ–≥–∫–æ —á–∏—Ç–∞–µ–º—ã–º. 
        - –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–∞–Ω –≤ —Ñ–æ—Ä–º–µ —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è markdown –∏–ª–∏ html —Ä–∞–∑–º–µ—Ç–∫–∏
        - –î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏, * –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º, - –¥–ª—è –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ –ø—É–Ω–∫—Ç–æ–≤, _ –¥–ª—è –∫—É—Ä—Å–∏–≤–∞, –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ–ª—å–∑—è.
        - –ü–æ –≤—Å–µ–º—É —Ç–µ–∫—Å—Ç—É –æ—Ç–≤–µ—Ç–∞ —Å–∏–º–≤–æ–ª—ã ${escapeSymbols} –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã
        - –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–∞–Ω –≤ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–º –º–µ—Å–µ–Ω–¥–∂–µ—Ä–æ–º Telegram —Ñ–æ—Ä–º–∞—Ç–µ, –ø—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
        \`\`\`markdown
        —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ —Ç—É—Ç
        \`\`\`

        –ó–∞–∫–æ–Ω—á–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω—É–∂–Ω–æ —á–µ—Ç–≤–µ—Ä—Ç—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –∏ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤–æ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –≤ –¥–µ–ª–æ–≤–æ–º —Å—Ç–∏–ª–µ –Ω–∞ –¥–≤—É—Ö–º–µ—Å—è—á–Ω–æ–µ –≤–µ–¥–µ–Ω–∏–µ.
        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç—Ä–µ—Ö.
        –ü—Ä–∏–º–µ—Ä –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ —á–µ—Ç–≤–µ—Ä—Ç–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:
        "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–¥–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑—ã –∏ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é –∏ –ø—Ä–∏–µ–º—É –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∏ –º–∏–Ω–µ—Ä–∞–ª–æ–≤,
        —Ç–æ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫ –î–≤–æ–π–Ω–∏—à–Ω–∏–∫–æ–≤–æ–π –î–∞—Ä—å–µ, –¥–∏–ø–ª–æ–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥—É."

        –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç–≤–µ—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –µ–≥–æ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –∏ –æ–ø–µ—á–∞—Ç–æ–∫.
    `;

const getRecipeMessage = () => `
    –ù–∞–ø–∏—à–∏ —Ä–µ—Ü–µ–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —Å—á–∏—Ç–∞–µ—à—å –ø–æ–ª–µ–∑–Ω—ã–º –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è –∏ —Ö–æ—á–µ—à—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏.
    –†–µ—Ü–µ–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –±–æ–ª–µ–µ 5 –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤.
    –†–µ—Ü–µ–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ—Å—Ç—ã–º –∏ –±—ã—Å—Ç—Ä—ã–º –≤ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–∏.
    –†–µ—Ü–µ–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–ø–∏—Å–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Ç–µ–∫—Å—Ç–∞ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è markdown –∏–ª–∏ html —Ä–∞–∑–º–µ—Ç–∫–∏.
    –ü—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Ä–µ—Ü–µ–ø—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ –∏ –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–ª–æ–≤–∞.
    –ü—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Ä–µ—Ü–µ–ø—Ç–∞ —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ä—Ü–∏–π, –≤—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è –∏ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å.
    –£–∫–∞–∂–∏ –≤ –∫–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø–æ–ø—É–ª—è—Ä–µ–Ω —ç—Ç–æ—Ç —Ä–µ—Ü–µ–ø—Ç –∏ –ø–æ—á–µ–º—É —Ç—ã —Å—á–∏—Ç–∞–µ—à—å –µ–≥–æ –ø–æ–ª–µ–∑–Ω—ã–º.

    –ó–∞–∫–æ–Ω—á–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç –Ω—É–∂–Ω–æ –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤—ã–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º –≤ –¥–µ–ª–æ–≤–æ–º —Å—Ç–∏–ª–µ –Ω–∞ –¥–≤—É—Ö–º–µ—Å—è—á–Ω–æ–µ –≤–µ–¥–µ–Ω–∏–µ.
    –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —Ä–µ—Ü–µ–ø—Ç–∞. –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ —Å–Ω–∏–∑—É.
    –ü—Ä–∏–º–µ—Ä –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:
    "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞—Ü–∏–æ–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é, –∑–∞–¥–∞—Ç—å —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑—ã –∏ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é –∏ –ø—Ä–∏–µ–º—É –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∏ –º–∏–Ω–µ—Ä–∞–ª–æ–≤,
    —Ç–æ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫ –¥–∏–ø–ª–æ–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥—É, –î–≤–æ–π–Ω–∏—à–Ω–∏–∫–æ–≤–æ–π –î–∞—Ä—å–µ."

    –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –æ—Ç–≤–µ—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å –µ–≥–æ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –∏ –æ–ø–µ—á–∞—Ç–æ–∫.
`;

const botConnect = (token: string, ai: ReturnType<typeof openaiConnect>) => {
    const bot = new Telegraf(token);
    bot.start((ctx) =>
        ctx.reply(
            `–ü—Ä–∏–≤–µ—Ç ${ctx.message.from.first_name}! 
–Ø –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–∏—Ç–∞–Ω–∏—é! ü´ê
–û–ø–∏—à–∏ –ø–æ–¥—Ä–æ–±–Ω–æ —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å –∏ —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å –ø–æ–ª—É—á–∏—Ç—å –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ —Ä–∞–±–æ—Ç—ã —Å –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥–æ–º, –∏ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å —Ç–µ–±–µ! üçè`
        )
    );

    bot.hears(/–ø—Ä–∏–≤|–∑–¥—Ä–∞–≤—Å—Ç/iu, (ctx) => ctx.sendSticker('CAACAgIAAxkBAAELH8FnaStKYP0XDy5LL98x7I_Ej2SV3wAC1xQAAtzRCUn4G0gDnaqg-DYE'));

    bot.telegram.setMyCommands([
        { command: 'start', description: '–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ü§ñ' },
        { command: 'recipe', description: '–ü–æ–ª–µ–∑–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç ü•ô' },
    ]);

    bot.command('recipe', async (ctx) => {
        try {
            const completion = await ai(getRecipeMessage());
            await ctx.reply(
                completion.choices[0].message.content ?? '–°–µ–≥–æ–¥–Ω—è —Ä–µ—Ü–µ–ø—Ç–æ–≤ –Ω–µ—Ç üòî',
                Markup.inlineKeyboard([Markup.button.callback('–ó–∞–ø–∏—Å—å –Ω–∞ —Ä–∞–∑–±–æ—Ä', 'signup')])
            );
        } catch (error) {
            console.error('bot.command(recipe)) error:', error);
            await ctx.reply('–°–µ–≥–æ–¥–Ω—è —Ä–µ—Ü–µ–ø—Ç–æ–≤ –Ω–µ—Ç üòî');
        }
    });

    bot.action('signup', async (ctx) => {
        await ctx.reply('–ó–∞–ø–∏—Å—å –Ω–∞ —Ä–∞–∑–±–æ—Ä –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π');
        await ctx.replyWithContact('+79115291121', '–î–∞—Ä—å—è –î–≤–æ–π–Ω–∏—à–Ω–∏–∫–æ–≤–∞');
    });
    bot.action('recipe', async (ctx) => {
        try {
            const completion = await ai(getRecipeMessage());
            await ctx.reply(
                completion.choices[0].message.content ?? '–°–µ–≥–æ–¥–Ω—è —Ä–µ—Ü–µ–ø—Ç–æ–≤ –Ω–µ—Ç üòî',
                Markup.inlineKeyboard([Markup.button.callback('–ó–∞–ø–∏—Å—å –Ω–∞ —Ä–∞–∑–±–æ—Ä', 'signup')])
            );
        } catch (error) {
            console.error('bot.command(recipe)) error:', error);
            await ctx.reply('–°–µ–≥–æ–¥–Ω—è —Ä–µ—Ü–µ–ø—Ç–æ–≤ –Ω–µ—Ç üòî');
        }
    });

    bot.on(message('text'), async (ctx) => {
        try {
            const completion = await ai(getRecommendationMessage(ctx.message.text.trim()));
            await ctx.reply(
                completion.choices[0].message.content ?? '–ù–µ –º–æ–≥—É –ø–æ–º–æ—á—å',
                Markup.inlineKeyboard([
                    Markup.button.callback('–ó–∞–ø–∏—Å—å –Ω–∞ —Ä–∞–∑–±–æ—Ä', 'signup'),
                    Markup.button.callback('–ü–æ–ª–µ–∑–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç', 'recipe'),
                ])
            );
        } catch (error) {
            console.error('bot.on(message(text)) error:', error);
            await ctx.reply('–ù–µ –º–æ–≥—É –ø–æ–º–æ—á—å –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
        }
    });

    bot.launch({
        webhook: {
            domain: 'nutribot.slim-r35.workers.dev',
            port: 443,
        },
    });

    process.once('SIGINT', () => bot.stop('SIGINT'));
    process.once('SIGTERM', () => bot.stop('SIGTERM'));

    return bot;
};

const openaiConnect = (token: string) => {
    const client = new OpenAI({
        apiKey: token,
    });

    return (message = '') =>
        client.chat.completions.create({
            model,
            messages: [
                {
                    role: 'system',
                    content:
                        '–¢—ã –æ–ø—ã—Ç–Ω—ã–π –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ —Å–æ —Å—Ç–∞–∂–µ–º —Ä–∞–±–æ—Ç—ã –±–æ–ª–µ–µ 10 –ª–µ—Ç –∏ –≤—ã—Å—à–∏–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º. –¢–µ–±–µ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫–ª–∏–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ç—è—Ç –Ω–∞–ª–∞–¥–∏—Ç—å –∏ —É–ª—É—á—à–∏—Ç—å —Å–≤–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∂–∏–∑–Ω–∏ —á–µ—Ä–µ–∑ –ø–∏—Ç–∞–Ω–∏–µ –∏ –ø—Ä–∏–µ–º –≤–∏—Ç–∞–º–∏–Ω–æ–≤ –∏ –º–∏–Ω–µ—Ä–∞–ª–æ–≤, –∞ —Ç–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∑–¥–æ—Ä–æ–≤–æ–≥–æ –æ–±—Ä–∞–∑–∞ –∂–∏–∑–Ω–∏',
                },
                {
                    role: 'user',
                    content: message,
                },
            ],
        });
};

router.post('/', async (request, env: Env, ctx) => {
    const ai = openaiConnect(env.OPENAI_TOKEN);
    const bot = botConnect(env.TELEGRAM_TOKEN, ai);

    const update = await request.json();
    await bot.handleUpdate(update as Update);

    return new Response(JSON.stringify({ data: 'Success' }));
});

router.all('*', () => new Response('Not Found', { status: 404 }));

export default router satisfies ExportedHandler<Env>;
